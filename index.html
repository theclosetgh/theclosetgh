<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>THE CLOSET</title>

<meta name="description" content="THE CLOSET GH â€” quality tops and streetwear. Shop new arrivals and order via WhatsApp.">
<link rel="canonical" href="https://www.theclosetgh.com/">

<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:Arial,sans-serif;background:#f8f8f8;color:#333}

  /* Header */
  header{background:#000;color:#fff;padding:20px 0;text-align:center;position:sticky;top:0;z-index:1000}
  header h1{letter-spacing:3px;font-size:2rem;margin-bottom:10px}
  nav{display:flex;gap:14px;justify-content:center;align-items:center;flex-wrap:wrap}
  nav a{color:#fff;text-decoration:none;margin:0 8px;font-weight:bold}
  nav a:hover{color:#ff4081}

  /* Cart button */
  .cart-btn{
    border:1px solid rgba(255,255,255,.25);
    background:rgba(255,255,255,.08);
    color:#fff;
    padding:8px 12px;
    border-radius:999px;
    font-weight:900;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:8px;
    transition:transform .12s ease, opacity .12s ease;
  }
  .cart-btn:hover{opacity:.95;transform:translateY(-1px)}
  .cart-badge{
    min-width:22px;height:22px;padding:0 7px;
    border-radius:999px;background:#ff4081;
    display:inline-flex;align-items:center;justify-content:center;
    font-size:.8rem;font-weight:900;
  }

  /* Hero */
  .hero{width:100%;height:100vh;background:url('home.jpg') no-repeat center center/cover;display:flex;align-items:center;justify-content:center;position:relative;text-align:center;color:#fff}
  .hero::after{content:'';position:absolute;inset:0;background:rgba(0,0,0,.5)}
  .hero-content{position:relative;z-index:2;padding:0 14px;max-width:900px}
  .hero h2{font-size:3rem;margin-bottom:18px}
  .hero button{background:#ff4081;border:none;color:#fff;padding:15px 30px;font-size:1.2rem;cursor:pointer;border-radius:10px}
  .hero button:hover{opacity:.92}

  /* Sections */
  section{padding:50px 20px;max-width:1200px;margin:auto}
  section h2{text-align:center;margin-bottom:16px}
  .hint{max-width:860px;margin:0 auto 22px auto;text-align:center;color:#666;line-height:1.5}

  /* Products */
  .products{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:25px}
  .product{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 10px rgba(0,0,0,.1);padding-bottom:15px;transition:transform .3s;position:relative}
  .product:hover{transform:translateY(-5px)}
  .product img{width:100%;height:300px;object-fit:contain;background:#fff}
  .product-content{padding:15px;text-align:center}
  .product-content h3{margin-bottom:5px}
  .product-content p{font-size:.95rem;color:#666}

  .badge-top{position:absolute;top:12px;left:12px;background:#111;color:#fff;font-weight:bold;padding:6px 10px;border-radius:999px;font-size:.85rem}
  .badge-top.out{background:#b00020}

  .price{margin:10px 0;display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap}
  .price .old{color:#999;text-decoration:line-through;font-weight:bold}
  .price .new{color:#ff4081;font-weight:bold}
  .price .disc{background:#ff4081;color:#fff;font-weight:bold;padding:4px 8px;border-radius:999px;font-size:.85rem}

  label{display:block;margin-top:10px;font-weight:bold}
  select,input[type="number"]{margin-top:5px;padding:8px;width:85%;border:1px solid #ddd;border-radius:8px}

  .btnRow{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap;margin-top:12px}
  .btn{
    display:inline-block;
    padding:10px 18px;
    border:none;
    border-radius:8px;
    font-weight:900;
    cursor:pointer;
    transition:opacity .12s ease, transform .12s ease;
  }
  .btn:hover{opacity:.92;transform:translateY(-1px)}
  .btn.disabled{background:#cfcfcf;color:#666;pointer-events:none;cursor:not-allowed;transform:none}
  .btn-cart{background:#111;color:#fff}
  .btn-cart.disabled{background:#cfcfcf;color:#666}

  /* Contact */
  .contact{text-align:center;background:#fff;padding:30px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.05)}
  .contact a{display:block;margin-top:10px;text-decoration:none;color:#000;font-weight:bold}
  .contact a:hover{text-decoration:underline}

  /* Footer */
  footer{background:#000;color:#fff;text-align:center;padding:20px;margin-top:40px}

  /* Responsive */
  @media (max-width:768px){
    .hero h2{font-size:2rem}
    .products{grid-template-columns:repeat(2,1fr)}
  }
  @media (max-width:480px){
    .products{grid-template-columns:1fr}
    select,input[type="number"]{width:100%}
  }

  /* Cart Drawer */
  .cartOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9000}
  .cartOverlay.show{display:block}

  .cartDrawer{
    position:fixed;top:0;right:0;height:100%;
    width:min(420px,92vw);
    background:#fff;
    z-index:9100;
    transform:translateX(110%);
    transition:transform .18s ease;
    box-shadow:-10px 0 30px rgba(0,0,0,.18);
    display:flex;flex-direction:column;
  }
  .cartDrawer.show{transform:translateX(0)}

  .cartHead{
    padding:16px;border-bottom:1px solid rgba(0,0,0,.08);
    display:flex;align-items:center;justify-content:space-between;gap:10px;
  }
  .cartHead h3{margin:0;font-size:1.1rem;letter-spacing:.3px}
  .cartClose{
    border:1px solid rgba(0,0,0,.15);
    background:#fff;border-radius:10px;
    padding:8px 10px;cursor:pointer;font-weight:900;
  }

  .cartBody{padding:14px 16px;overflow:auto;flex:1}
  .cartEmpty{color:#666;text-align:center;padding:26px 8px}

  .cartItem{display:flex;gap:12px;padding:12px 0;border-bottom:1px solid rgba(0,0,0,.08)}
  .cartThumb{width:74px;height:92px;border-radius:12px;background:#f2f2f2;overflow:hidden;flex:0 0 auto;border:1px solid rgba(0,0,0,.06)}
  .cartThumb img{width:100%;height:100%;object-fit:contain;background:#fff;display:block}
  .cartMain{flex:1;min-width:0}
  .cartTitle{font-weight:900;font-size:.95rem;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .cartSub{color:#666;font-size:.86rem;margin-bottom:8px;line-height:1.35}
  .cartRow{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .qty{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(0,0,0,.12);border-radius:999px;padding:6px 10px}
  .qty button{border:none;background:transparent;cursor:pointer;font-weight:900;font-size:1rem;width:24px;height:24px;border-radius:6px}
  .qty span{min-width:18px;text-align:center;font-weight:900}
  .cartPrice{font-weight:900;color:#ff4081;font-size:.95rem}
  .cartRemove{border:none;background:transparent;cursor:pointer;font-weight:900;color:#111;opacity:.75}
  .cartRemove:hover{opacity:1}

  .cartFoot{border-top:1px solid rgba(0,0,0,.08);padding:14px 16px 16px;background:#fff}
  .totals{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px;font-weight:900}
  .note{font-size:.88rem;color:#666;margin-bottom:12px;line-height:1.35}
  .cartActions{display:flex;gap:10px}
  .cartActions button,.cartActions a{
    flex:1;text-align:center;text-decoration:none;border-radius:10px;
    padding:11px 14px;font-weight:900;font-size:.92rem;
    border:none;cursor:pointer;
  }
  .clearBtn{background:#fff;border:1px solid rgba(0,0,0,.18)}
  .checkoutBtn{background:#25D366;color:#fff}

  /* Toast */
  .toast{
    position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
    background:#111;color:#fff;padding:10px 14px;border-radius:999px;
    font-weight:900;font-size:.9rem;opacity:0;pointer-events:none;
    transition:opacity .18s ease, transform .18s ease;
    z-index:99999;
  }
  .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}
</style>
</head>

<body>
<header>
  <h1>THE CLOSET</h1>
  <nav>
    <a href="#home">HOME</a>
    <a href="#shop">SHOP</a>
    <a href="#contact">CONTACT</a>

    <button class="cart-btn" type="button" id="openCartBtn" aria-label="Open cart">
      CART <span class="cart-badge" id="cartCount">0</span>
    </button>
  </nav>
</header>

<section id="home" class="hero">
  <div class="hero-content">
    <h2>Welcome to THE CLOSET</h2>
    <button onclick="document.getElementById('shop').scrollIntoView({behavior:'smooth'})">Shop Now</button>
  </div>
</section>

<section id="shop">
  <h2>Available Tops</h2>
 <div id="sectionMenu" class="btnRow" style="margin-bottom:25px"></div>
  <p class="hint">
    All items are online â€” everyone sees the same stock.<br>
    Add items to cart, then checkout on WhatsApp. Delivery (if selected) is via Yango or Bolt.
  </p>
  <div class="products" id="productsGrid"></div>
</section>

<section id="contact">
  <h2>Contact</h2>
  <div class="contact">
    <a href="https://wa.me/233547706620" target="_blank">WhatsApp: 0547706620</a>
    <a href="https://www.tiktok.com/@the.closetgh" target="_blank">TikTok: @theclosetgh</a>
  </div>
</section>

<footer>
  <p>Â© 2026 THE CLOSET</p>
</footer>

<!-- CART -->
<div class="cartOverlay" id="cartOverlay"></div>

<aside class="cartDrawer" id="cartDrawer" aria-hidden="true">
  <div class="cartHead">
    <h3>Your Cart</h3>
    <button class="cartClose" type="button" id="closeCartBtn">Close</button>
  </div>

  <div class="cartBody" id="cartBody"></div>

  <div class="cartFoot">
    <div class="totals">
      <span>Total</span>
      <span id="cartTotal">GHC 0</span>
    </div>
    <div class="note" id="deliveryNote"></div>
    <div class="cartActions">
      <button class="clearBtn" type="button" id="clearCartBtn">Clear</button>
      <a class="checkoutBtn" id="checkoutBtn" target="_blank" href="#">Checkout</a>
    </div>
  </div>
</aside>

<div class="toast" id="toast">Added to cart</div>

<script>
  /* ==========================
     CLOUDFLARE API SETTINGS
     ========================== */
  const API_BASE = "https://the-closet-api.edriatebi2.workers.dev";

  /* ==========================
     SETTINGS (EDIT HERE ONLY)
     ========================== */
  const WHATSAPP_NUMBER = "233547706620";
  const DELIVERY_TEXT = "Delivery (if selected) will be arranged via Yango or Bolt.";
  const SCREENSHOT_TEXT = "Please send screenshots of the selected item(s) from the website.";
  const AUTO_OPEN_CART_AFTER_ADD = false;
  const CART_KEY = "thecloset_cart_v2";

  document.getElementById("deliveryNote").innerHTML =
    `Checkout is via WhatsApp. <strong>${DELIVERY_TEXT}</strong>`;

  const grid = document.getElementById("productsGrid");
  const toastEl = document.getElementById("toast");

  function money(n){ return `GHC ${Math.round(Number(n||0))}`; }
  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function showToast(text){
    toastEl.textContent = text || "Done";
    toastEl.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> toastEl.classList.remove("show"), 1200);
  }
  async function apiGet(path){
       const res = await fetch(API_BASE + path, { method:"GET" });
    const text = await res.text();
    let data = {};
    try{ data = JSON.parse(text); }catch(e){ data = { ok:false, error:"Invalid JSON from API", raw:text }; }
    if(!res.ok) throw new Error(data.error || ("HTTP " + res.status));
    return data;
  }
 
async function loadSections(){
  const data = await apiGet("/api/sections");
  const menu = document.getElementById("sectionMenu");

  if(!data.sections || data.sections.length === 0){
    menu.innerHTML = "";
    return;
  }

  menu.innerHTML = `
    <button class="btn btn-cart" data-sec="all">All</button>
    ${data.sections.map(s => `
      <button class="btn btn-cart" data-sec="${s.slug}">
        ${s.name}
      </button>
    `).join("")}
  `;

  menu.querySelectorAll("button").forEach(btn => {
btn.addEventListener("click", ()=>{
  activeSection = btn.dataset.sec.toLowerCase();
  applySectionFilter();
});
 }
  // Live product cache
  const productCache = new Map();

  function getDiscountPercent(p){
    const val = Number(p.discountPercent);
    return Number.isFinite(val) && val > 0 ? val : 0;
  }
  function finalPrice(p){
    const base = Number(p.price || 0);
    const discEnabled = !!p.discountEnabled;
    const discPct = discEnabled ? getDiscountPercent(p) : 0;
    if(discPct > 0) return base * (100 - discPct) / 100;
    return base;
  }

  // CART (localStorage)
  let cart = loadCart();

  function loadCart(){
    try{
      const raw = localStorage.getItem(CART_KEY);
      if(!raw) return {};
      const parsed = JSON.parse(raw);
      return (parsed && typeof parsed === "object") ? parsed : {};
    }catch(e){
      return {};
    }
  }
  function saveCart(){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }

  function cartCount(){
    return Object.values(cart).reduce((sum,it)=> sum + (Number(it.qty)||0), 0);
  }
  function cartTotal(){
    return Object.values(cart).reduce((sum,it)=> sum + (Number(it.unitPrice)||0) * (Number(it.qty)||0), 0);
  }
  function setCartBadge(){
    document.getElementById("cartCount").textContent = cartCount();
    document.getElementById("cartTotal").textContent = money(cartTotal());
  }
  function cartKeyFrom(productId,size){
    return `${productId}__${String(size||"").toLowerCase()}`;
  }
  function addToCart(item){
    const key = cartKeyFrom(item.productId, item.size);
    if(cart[key]) cart[key].qty += Number(item.qty)||1;
    else cart[key] = { key, ...item, qty: Number(item.qty)||1 };
    saveCart(); renderCart(); setCartBadge();
  }
  function incQty(key){ if(cart[key]){ cart[key].qty += 1; saveCart(); renderCart(); setCartBadge(); } }
  function decQty(key){
    if(!cart[key]) return;
    cart[key].qty -= 1;
    if(cart[key].qty <= 0) delete cart[key];
    saveCart(); renderCart(); setCartBadge();
  }
  function removeItem(key){ if(cart[key]){ delete cart[key]; saveCart(); renderCart(); setCartBadge(); } }
  function clearCart(){ cart = {}; saveCart(); renderCart(); setCartBadge(); }

  // CART UI
  const cartOverlay = document.getElementById("cartOverlay");
  const cartDrawer = document.getElementById("cartDrawer");
  const openCartBtn = document.getElementById("openCartBtn");
  const closeCartBtn = document.getElementById("closeCartBtn");
  const clearCartBtn = document.getElementById("clearCartBtn");
  const checkoutBtn = document.getElementById("checkoutBtn");
  const cartBody = document.getElementById("cartBody");

  function openCart(){
    cartOverlay.classList.add("show");
    cartDrawer.classList.add("show");
    cartDrawer.setAttribute("aria-hidden","false");
  }
  function closeCart(){
    cartOverlay.classList.remove("show");
    cartDrawer.classList.remove("show");
    cartDrawer.setAttribute("aria-hidden","true");
  }
  openCartBtn.addEventListener("click", openCart);
  closeCartBtn.addEventListener("click", closeCart);
  cartOverlay.addEventListener("click", closeCart);
  clearCartBtn.addEventListener("click", clearCart);

  function renderCart(){
    const items = Object.values(cart);
    if(items.length === 0){
      cartBody.innerHTML = `<div class="cartEmpty">Your cart is empty. Add items from the shop.</div>`;
      return;
    }
    cartBody.innerHTML = items.map(it=>{
      const lineTotal = (Number(it.unitPrice)||0) * (Number(it.qty)||0);
      const live = productCache.get(it.productId);
      const warn = (!live || live.outOfStock) ? `<div style="color:#b00020;font-weight:900;font-size:.85rem;margin-top:4px;">Currently unavailable</div>` : "";
      return `
        <div class="cartItem">
          <div class="cartThumb">
            <img src="${escapeHtml(it.imageUrl || 'home.jpg')}" alt="${escapeHtml(it.name)}">
          </div>
          <div class="cartMain">
            <div class="cartTitle">${escapeHtml(it.name)}</div>
            <div class="cartSub">
              Size: ${escapeHtml(it.size)} â€¢ ${money(it.unitPrice)} each
              ${warn}
            </div>
            <div class="cartRow">
              <div class="qty">
                <button type="button" aria-label="Decrease" data-dec="${escapeHtml(it.key)}">âˆ’</button>
                <span>${it.qty}</span>
                <button type="button" aria-label="Increase" data-inc="${escapeHtml(it.key)}">+</button>
              </div>
              <div class="cartPrice">${money(lineTotal)}</div>
              <button class="cartRemove" type="button" data-rm="${escapeHtml(it.key)}">Remove</button>
            </div>
          </div>
        </div>
      `;
    }).join("");

    cartBody.querySelectorAll("[data-inc]").forEach(b=> b.addEventListener("click", ()=> incQty(b.getAttribute("data-inc"))));
    cartBody.querySelectorAll("[data-dec]").forEach(b=> b.addEventListener("click", ()=> decQty(b.getAttribute("data-dec"))));
    cartBody.querySelectorAll("[data-rm]").forEach(b=> b.addEventListener("click", ()=> removeItem(b.getAttribute("data-rm"))));
  }

  function validateCartAgainstLiveStock(){
    const items = Object.values(cart);
    const issues = [];
    for(const it of items){
      const live = productCache.get(it.productId);
      if(!live){ issues.push(`â€¢ ${it.name} (not found / removed)`); continue; }
      if(!!live.outOfStock){ issues.push(`â€¢ ${live.name || it.name} (out of stock)`); continue; }
      const liveSizes = Array.isArray(live.sizes) && live.sizes.length ? live.sizes : null;
      if(liveSizes && !liveSizes.includes(it.size)){
        issues.push(`â€¢ ${live.name || it.name} (size ${it.size} unavailable)`);
      }
    }
    return issues;
  }

  // CHECKOUT -> WhatsApp
  checkoutBtn.addEventListener("click", (e)=>{
    e.preventDefault();
    const items = Object.values(cart);
    if(items.length === 0){ alert("Your cart is empty."); return; }

    const issues = validateCartAgainstLiveStock();
    if(issues.length){
      alert("Some items in your cart are not available right now:\n\n" + issues.join("\n") + "\n\nPlease remove them and try again.");
      openCart();
      return;
    }

    const lines = items.map((it, idx)=>{
      const lineTotal = (Number(it.unitPrice)||0) * (Number(it.qty)||0);
      return `${idx+1}) ${it.name} | Size: ${it.size} | Qty: ${it.qty} | ${money(lineTotal)}`;
    }).join("\n");

    const msg =
`Hello THE CLOSET ðŸ‘‹
I want to order the following items:

${lines}

Total: ${money(cartTotal())}

${DELIVERY_TEXT}
${SCREENSHOT_TEXT}
Please confirm availability.`;

    window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`, "_blank");
  });

  // PRODUCT CARDS
  function cardHTML(id, p){
    const name = String(p.name || "New Item");
    const sizes = Array.isArray(p.sizes) && p.sizes.length ? p.sizes : ["M","L","XL"];
    const out = !!p.outOfStock;

    const base = Number(p.price || 0);
    const discEnabled = !!p.discountEnabled;
    const discPct = discEnabled ? getDiscountPercent(p) : 0;
    const fin = finalPrice(p);

    const badge = out
      ? `<div class="badge-top out">OUT OF STOCK</div>`
      : (discEnabled && discPct > 0 ? `<div class="badge-top">DISCOUNT</div>` : "");

    const priceHTML = (discEnabled && discPct > 0)
      ? `<span class="old">${money(base)}</span><span class="new">${money(fin)}</span><span class="disc">${Math.round(discPct)}% OFF</span>`
      : `<span class="new">${money(base)}</span>`;

    const opts = sizes.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");
    const img = String(p.imageUrl || "home.jpg");

    return `
     <div class="product"
     data-id="${escapeHtml(id)}"
     data-out="${out?1:0}"
     data-section="${escapeHtml(p.section || '')}">
        ${badge}
        <img src="${escapeHtml(img)}" alt="${escapeHtml(name)}">
        <div class="product-content">
          <h3>${escapeHtml(name)}</h3>
          <p>${escapeHtml(sizes.join("/"))}</p>
          <div class="price">${priceHTML}</div>

          <label>Size:</label>
          <select class="size" ${out?"disabled":""}>${opts}</select>

          <label>Quantity:</label>
          <input type="number" class="quantity" min="1" max="10" value="1" ${out?"disabled":""}>

          <div class="btnRow">
            <button class="btn btn-cart ${out?"disabled":""}" type="button" data-action="addcart">
              ${out ? "Out of Stock" : "Add to Cart"}
            </button>
          </div>
        </div>
      </div>
    `;
  }

  function wireActions(){
    document.querySelectorAll(".product").forEach(card=>{
      const out = card.dataset.out === "1";
      if(out) return;

      const productId = card.dataset.id;
      const live = productCache.get(productId);
      if(!live) return;

      const name = String(live.name || card.querySelector("h3")?.innerText || "Item");
      const img = String(live.imageUrl || "home.jpg");

      const sizeEl = card.querySelector(".size");
      const qtyEl = card.querySelector(".quantity");
      const addBtn = card.querySelector("button[data-action='addcart']");

      addBtn.addEventListener("click", ()=>{
        const size = sizeEl.value;
        const qty = Number(qtyEl.value || 1);
        const unitPrice = finalPrice(live);

        addToCart({ productId, name, size, qty, unitPrice, imageUrl: img });
        showToast("Added to cart");
        if(AUTO_OPEN_CART_AFTER_ADD) openCart();
      });
    });
  }

  // ======= OPTION A FIX (FULL) =======
  // Only update DOM if products changed, no "Loading stuck", no overlap
  let lastProductsSignature = "";
  let hasRenderedProducts = false;
  let isLoadingProducts = false;
function signatureOfProducts(products){
  return JSON.stringify(
    (products || []).map(p => ({
      id: p.id,
      name: p.name,
      price: Number(p.price||0),
      sizes: Array.isArray(p.sizes) ? p.sizes : [],
      imageUrl: p.imageUrl,
      discountEnabled: !!p.discountEnabled,
      discountPercent: Number(p.discountPercent||0),
      outOfStock: !!p.outOfStock,
      section: String(p.section || "")   // âœ… FIX
    }))
  );
}

  async function loadProducts(){
    if(isLoadingProducts) return;
    isLoadingProducts = true;

    // show loading only on very first load
    if(!hasRenderedProducts){
      grid.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#666;">Loadingâ€¦</p>`;
    }

    try{
      const data = await apiGet("/api/products");
          const products = Array.isArray(data.products) ? data.products : [];

      // compute signature BEFORE touching DOM
      const sig = signatureOfProducts(products);

      // if nothing changed & we already rendered, don't touch grid
      if(hasRenderedProducts && sig === lastProductsSignature){
        renderCart(); setCartBadge();
        return;
      }
      lastProductsSignature = sig;

      const y = window.scrollY;

      productCache.clear();

      if(products.length === 0){
        grid.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#666;">No products yet.</p>`;
        hasRenderedProducts = true;
        renderCart(); setCartBadge();
        window.scrollTo(0, y);
        return;
      }

      for(const p of products){
        productCache.set(p.id, {
          id: p.id,
          name: p.name || "New Item",
          price: Number(p.price || 0),
          sizes: Array.isArray(p.sizes) ? p.sizes : ["M","L","XL"],
          outOfStock: !!p.outOfStock,
          imageUrl: p.imageUrl || "home.jpg",
          discountEnabled: !!p.discountEnabled,
          discountPercent: Number(p.discountPercent || 0),
          createdAt: p.createdAt || null
        });
      }

      grid.innerHTML = products.map(p => cardHTML(p.id, p)).join("");
wireActions();
applySectionFilter(); // âœ… IMPORTANT

      hasRenderedProducts = true;

      renderCart(); setCartBadge();
      window.scrollTo(0, y);
    }catch(err){
      if(!hasRenderedProducts){
        grid.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#b00020;">Failed to load products: ${escapeHtml(err.message||String(err))}</p>`;
      }
      renderCart(); setCartBadge();
    }finally{
      isLoadingProducts = false;
    }
  }

  // Init
  renderCart();
  setCartBadge();
 loadSections();
loadProducts();
  // Auto refresh (will re-render ONLY when products change)
  setInterval(loadProducts, 30000);
</script>
</body>
</html>



