<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>THE CLOSET – Workers</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body{font-family:Arial,sans-serif;background:#f5f5f5;padding:20px;color:#111}
  .wrap{max-width:1000px;margin:0 auto}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:14px}
  h1{margin:0}
  a{color:#000;font-weight:bold}

  .card{background:#fff;border-radius:12px;padding:18px;box-shadow:0 5px 15px rgba(0,0,0,.08);margin-bottom:16px}
  label{font-weight:bold;margin-top:10px;display:block}
  input,button{width:100%;padding:10px;margin-top:6px;border:1px solid #ccc;border-radius:8px;font-size:15px}
  button{background:#000;color:#fff;cursor:pointer}
  button:hover{opacity:.92}
  button:disabled{opacity:.65;cursor:not-allowed}
  .danger{background:#b00020}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:800px){.row{grid-template-columns:1fr}}

  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;vertical-align:middle}
  .tiny{font-size:.9rem;color:#666}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:bold;font-size:.85rem}
  .pill.on{background:#e9fff1;color:#0b6b2a;border:1px solid #bfeccc}
  .pill.off{background:#fff4f4;color:#8a0f0f;border:1px solid #f0c0c0}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btnSmall{width:auto;padding:8px 10px}
</style>
</head>
<body>

<!-- ✅ PIN LOCK -->
<script>
  (function () {
    const PIN = "2005";
    while (true) {
      const entered = prompt("Mr Edric kindly input your PIN");
      if (entered === null) { window.location.href = "./index.html"; return; }   // ✅ safer path
      if (entered.trim() === PIN) break;
      alert("Wrong PIN. Try again.");
    }
  })();
</script>

<div class="wrap">

  <header>
    <h1>Workers – Manage Products</h1>
    <a href="./index.html">← Back to Shop</a>  <!-- ✅ safer path -->
  </header>

  <div class="card">
    <h2 style="margin:0 0 10px;">Add New Product</h2>
    <form id="productForm">
      <div class="row">
        <div>
          <label>Product Name</label>
          <input type="text" id="name" placeholder="e.g. NEW UTOPIA TOP" required>
        </div>
        <div>
          <label>Price (GHC)</label>
          <input type="number" id="price" placeholder="e.g. 120" min="1" required>
        </div>
      </div>

      <label>Upload Product Image</label>
      <input type="file" id="imageFile" accept="image/*" required>

      <label>Sizes (comma separated)</label>
      <input type="text" id="sizes" placeholder="e.g. M,L,XL" required>

      <div class="row">
        <div>
          <label>Discount (per product)</label>
          <input type="checkbox" id="discountEnabled" style="width:auto; transform:scale(1.2); margin-top:10px;">
          <span class="tiny"> Enable discount</span>
        </div>
        <div>
          <label>Stock</label>
          <input type="checkbox" id="outOfStock" style="width:auto; transform:scale(1.2); margin-top:10px;">
          <span class="tiny"> Mark out of stock</span>
        </div>
      </div>

      <button type="submit" id="submitBtn">Upload & Add Product</button>
      <p class="tiny" style="margin-top:10px;">
        Upload is compressed automatically for speed.
      </p>
    </form>
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px;">Current Products</h2>
    <div class="tiny" style="margin-bottom:10px;">Confirm-style actions: Set Discount, Set Stock, Delete.</div>

    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>Preview</th>
            <th>Name</th>
            <th>Price</th>
            <th>Discount</th>
            <th>Stock</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="list"></tbody>
      </table>
    </div>
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getFirestore, collection, addDoc, serverTimestamp,
    query, orderBy, onSnapshot, doc, updateDoc, deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import {
    getStorage, ref, uploadBytes, getDownloadURL, deleteObject
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCcEqZ9Mga_JcVSAeQv1DKNLlo0QCItYI0",
    authDomain: "the-closet-ee4ef.firebaseapp.com",
    projectId: "the-closet-ee4ef",
    storageBucket: "the-closet-ee4ef.firebasestorage.app",
    messagingSenderId: "386905202760",
    appId: "1:386905202760:web:efe9e882049ce7ad31f87d",
    measurementId: "G-RK2H1B1CVW"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const form = document.getElementById("productForm");
  const submitBtn = document.getElementById("submitBtn");
  const list = document.getElementById("list");

  // ✅ Compress + resize BEFORE upload (faster)
  async function compressImage(file, maxW = 1200, quality = 0.7) {
    const img = new Image();
    const url = URL.createObjectURL(file);

    await new Promise((resolve, reject) => {
      img.onload = resolve;
      img.onerror = reject;
      img.src = url;
    });

    const scale = Math.min(1, maxW / img.width);
    const w = Math.round(img.width * scale);
    const h = Math.round(img.height * scale);

    const canvas = document.createElement("canvas");
    canvas.width = w;
    canvas.height = h;
    canvas.getContext("2d").drawImage(img, 0, 0, w, h);

    URL.revokeObjectURL(url);

    const blob = await new Promise(resolve =>
      canvas.toBlob(resolve, "image/jpeg", quality)
    );

    return new File([blob], file.name.replace(/\.\w+$/, "") + ".jpg", { type: "image/jpeg" });
  }

  // ✅ Add product
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = document.getElementById("name").value.trim();
    const price = Number(document.getElementById("price").value);
    const sizes = document.getElementById("sizes").value.split(",").map(s => s.trim()).filter(Boolean);
    const discountEnabled = document.getElementById("discountEnabled").checked;
    const outOfStock = document.getElementById("outOfStock").checked;

    const original = document.getElementById("imageFile").files[0];
    if (!original) { alert("Please upload an image."); return; }

    submitBtn.disabled = true;
    submitBtn.textContent = "Compressing...";

    try {
      const file = await compressImage(original, 1200, 0.7);

      submitBtn.textContent = "Uploading...";

      const safeName = name.replace(/[^\w\-]+/g, "_").toLowerCase();
      const path = `products/${Date.now()}_${safeName}_${file.name}`;
      const imgRef = ref(storage, path);

      await uploadBytes(imgRef, file);
      const imageUrl = await getDownloadURL(imgRef);

      await addDoc(collection(db, "products"), {
        name,
        price,
        sizes,
        imageUrl,
        imagePath: path,
        discountEnabled,
        outOfStock,
        createdAt: serverTimestamp()
      });

      alert("✅ Product added!");
      form.reset();
    } catch (err) {
      console.error(err);
      alert("❌ Failed. Check Firebase rules / connection. Try a smaller image if needed.");
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Upload & Add Product";
    }
  });

  // ✅ Render list (live)
  const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
  onSnapshot(q, (snap) => {
    if (snap.empty) {
      list.innerHTML = `<tr><td colspan="6">No products yet.</td></tr>`;
      return;
    }

    list.innerHTML = snap.docs.map(d => {
      const p = d.data();
      const id = d.id;

      const disc = p.discountEnabled ? `<span class="pill on">ON</span>` : `<span class="pill off">OFF</span>`;
      const stock = p.outOfStock ? `<span class="pill off">OUT</span>` : `<span class="pill on">IN</span>`;

      return `
        <tr data-id="${id}" data-path="${p.imagePath || ""}">
          <td>${p.imageUrl ? `<img src="${p.imageUrl}" style="width:55px;height:55px;object-fit:cover;border-radius:8px;">` : ""}</td>
          <td>${p.name || ""}</td>
          <td>GHC ${p.price || ""}</td>
          <td>${disc}</td>
          <td>${stock}</td>
          <td class="actions">
            <button type="button" class="btnSmall" data-action="set-discount">Set Discount</button>
            <button type="button" class="btnSmall" data-action="set-stock">Set Stock</button>
            <button type="button" class="btnSmall danger" data-action="delete">Delete</button>
          </td>
        </tr>
      `;
    }).join("");
  });

  // ✅ Confirm-style actions
  list.addEventListener("click", async (e) => {
    const btn = e.target.closest("button[data-action]");
    if (!btn) return;

    const row = btn.closest("tr[data-id]");
    const id = row.dataset.id;
    const imagePath = row.dataset.path;
    const refDoc = doc(db, "products", id);

    try {
      if (btn.dataset.action === "set-discount") {
        const setTo = confirm("Set DISCOUNT to ON?\nOK = ON, Cancel = OFF");
        await updateDoc(refDoc, { discountEnabled: setTo });
        return;
      }

      if (btn.dataset.action === "set-stock") {
        const setTo = confirm("Mark as OUT OF STOCK?\nOK = OUT, Cancel = IN STOCK");
        await updateDoc(refDoc, { outOfStock: setTo });
        return;
      }

      if (btn.dataset.action === "delete") {
        if (!confirm("Delete this product?")) return;

        await deleteDoc(refDoc);

        if (imagePath) {
          const imgRef = ref(storage, imagePath);
          await deleteObject(imgRef).catch(() => {});
        }

        alert("✅ Deleted");
      }
    } catch (err) {
      console.error(err);
      alert("❌ Action failed. Check Firebase rules/connection.");
    }
  });
</script>

</body>
</html>
