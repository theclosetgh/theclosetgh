<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>THE CLOSET – Workers</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body{font-family:Arial,sans-serif;background:#f5f5f5;padding:20px;color:#111}
  .wrap{max-width:1000px;margin:0 auto}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:14px}
  h1{margin:0}
  a{color:#000;font-weight:bold}
  .card{background:#fff;border-radius:12px;padding:18px;box-shadow:0 5px 15px rgba(0,0,0,.08);margin-bottom:16px}
  label{font-weight:bold;margin-top:10px;display:block}
  input,button{width:100%;padding:10px;margin-top:6px;border:1px solid #ccc;border-radius:8px;font-size:15px}
  button{background:#000;color:#fff;cursor:pointer}
  button:hover{opacity:.92}
  button:disabled{opacity:.65;cursor:not-allowed}
  .danger{background:#b00020}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:800px){.row{grid-template-columns:1fr}}

  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;vertical-align:middle}
  .tiny{font-size:.9rem;color:#666}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:bold;font-size:.85rem}
  .pill.on{background:#e9fff1;color:#0b6b2a;border:1px solid #bfeccc}
  .pill.off{background:#fff4f4;color:#8a0f0f;border:1px solid #f0c0c0}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btnSmall{width:auto;padding:8px 10px}
  .topActions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .hide{display:none}

  /* tiny loading bar */
  #gateLoading{display:flex;align-items:center;gap:10px}
  .dot{width:10px;height:10px;border-radius:50%;background:#000;opacity:.15;animation:blink 1.1s infinite}
  .dot:nth-child(2){animation-delay:.2s}
  .dot:nth-child(3){animation-delay:.4s}
  @keyframes blink{0%,100%{opacity:.15}50%{opacity:.9}}
</style>
</head>

<body>
<div class="wrap">
  <header>
    <h1>Workers – Manage Products</h1>
    <div class="topActions">
      <a href="/index.html">← Back to Shop</a>
      <button id="logoutBtn" class="btnSmall danger hide" type="button">Log out</button>
    </div>
  </header>

  <!-- Gate loading (prevents flash of page to normal users) -->
  <div class="card" id="gateCard">
    <div id="gateLoading">
      <span style="font-weight:bold;">Checking access</span>
      <span class="dot"></span><span class="dot"></span><span class="dot"></span>
    </div>
    <p class="tiny" style="margin-top:8px;">Authorized staff only.</p>
  </div>

  <!-- LOGIN CARD -->
  <div class="card hide" id="loginCard">
    <h2 style="margin:0 0 10px;">Worker Login</h2>
    <p class="tiny">Only approved workers can manage products.</p>

    <form id="loginForm">
      <label>Email</label>
      <input type="email" id="loginEmail" placeholder="worker@email.com" required>

      <label>Password</label>
      <input type="password" id="loginPass" placeholder="********" required>

      <button type="submit" id="loginBtn">Sign in</button>
    </form>
  </div>

  <!-- MAIN WORKERS UI -->
  <div id="workersUI" class="hide">

    <div class="card">
      <h2 style="margin:0 0 10px;">Add New Product</h2>
      <form id="productForm">
        <div class="row">
          <div>
            <label>Product Name</label>
            <input type="text" id="name" required>
          </div>
          <div>
            <label>Price (GHC)</label>
            <input type="number" id="price" min="1" required>
          </div>
        </div>

        <label>Upload Product Image</label>
        <input type="file" id="imageFile" accept="image/*" required>

        <label>Sizes (comma separated)</label>
        <input type="text" id="sizes" placeholder="M,L,XL" required>

        <div class="row">
          <div>
            <label>Discount (per product)</label>
            <input type="checkbox" id="discountEnabled" style="width:auto; transform:scale(1.2); margin-top:10px;">
            <span class="tiny"> Enable discount</span>
          </div>
          <div>
            <label>Stock</label>
            <input type="checkbox" id="outOfStock" style="width:auto; transform:scale(1.2); margin-top:10px;">
            <span class="tiny"> Mark out of stock</span>
          </div>
        </div>

        <button type="submit" id="submitBtn">Upload & Add Product</button>
        <p class="tiny" style="margin-top:10px;">
          Cloudinary preset must be UNSIGNED and named <b>the_closet</b>.
        </p>
      </form>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px;">Current Products</h2>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Preview</th>
              <th>Name</th>
              <th>Price</th>
              <th>Discount</th>
              <th>Stock</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="list"></tbody>
        </table>
      </div>
      <p class="tiny" style="margin-top:10px;">
        If you are logged in but actions fail, your email may not be in the approved list in Firestore (admins/allowed).
      </p>
    </div>

  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getFirestore, collection, addDoc, serverTimestamp,
    query, orderBy, onSnapshot, doc, updateDoc, deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import {
    getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  // Firebase (NO analytics)
  const firebaseConfig = {
    apiKey: "AIzaSyCcEqZ9Mga_JcVSAeQv1DKNLlo0QCItYI0",
    authDomain: "the-closet-ee4ef.firebaseapp.com",
    projectId: "the-closet-ee4ef",
    messagingSenderId: "386905202760",
    appId: "1:386905202760:web:efe9e882049ce7ad31f87d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // Cloudinary
  const CLOUD_NAME = "dwpwtanc8";
  const UPLOAD_PRESET = "the_closet";

  // UI elements
  const gateCard = document.getElementById("gateCard");
  const loginCard = document.getElementById("loginCard");
  const loginForm = document.getElementById("loginForm");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const workersUI = document.getElementById("workersUI");

  const productForm = document.getElementById("productForm");
  const submitBtn = document.getElementById("submitBtn");
  const list = document.getElementById("list");

  // Gate: if not logged in, show login; no access without auth
  onAuthStateChanged(auth, (user) => {
    gateCard.classList.add("hide");

    if (!user) {
      // not logged in → show login only
      workersUI.classList.add("hide");
      logoutBtn.classList.add("hide");
      loginCard.classList.remove("hide");
      list.innerHTML = "";
      return;
    }

    // logged in → show workers UI
    loginCard.classList.add("hide");
    workersUI.classList.remove("hide");
    logoutBtn.classList.remove("hide");
    startLiveList();
  });

  // Login
  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    loginBtn.disabled = true;
    loginBtn.textContent = "Signing in...";
    try {
      const email = document.getElementById("loginEmail").value.trim();
      const pass = document.getElementById("loginPass").value;
      await signInWithEmailAndPassword(auth, email, pass);
    } catch (err) {
      alert("❌ Login failed: " + (err.message || "Try again"));
    } finally {
      loginBtn.disabled = false;
      loginBtn.textContent = "Sign in";
    }
  });

  // Logout
  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
  });

  // Cloudinary upload
  async function uploadToCloudinary(file){
    const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
    const fd = new FormData();
    fd.append("file", file);
    fd.append("upload_preset", UPLOAD_PRESET);
    fd.append("folder", "the-closet");

    const res = await fetch(url, { method:"POST", body: fd });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error?.message || "Cloudinary upload failed");
    return data.secure_url;
  }

  // Add product
  productForm.addEventListener("submit", async (e)=>{
    e.preventDefault();

    const name = document.getElementById("name").value.trim();
    const price = Number(document.getElementById("price").value);
    const sizes = document.getElementById("sizes").value.split(",").map(s=>s.trim()).filter(Boolean);
    const discountEnabled = document.getElementById("discountEnabled").checked;
    const outOfStock = document.getElementById("outOfStock").checked;

    const file = document.getElementById("imageFile").files[0];
    if(!file){ alert("Upload an image."); return; }

    submitBtn.disabled = true;
    submitBtn.textContent = "Uploading image...";

    try{
      const imageUrl = await uploadToCloudinary(file);
      submitBtn.textContent = "Saving product...";

      await addDoc(collection(db,"products"),{
        name, price, sizes, imageUrl,
        discountEnabled, outOfStock,
        createdAt: serverTimestamp()
      });

      alert("✅ Product added!");
      productForm.reset();
    }catch(err){
      console.error(err);
      alert("❌ Failed: " + (err.message || "Try again"));
    }finally{
      submitBtn.disabled = false;
      submitBtn.textContent = "Upload & Add Product";
    }
  });

  // Live list
  let unsub = null;
  function startLiveList(){
    if (unsub) return;

    const qy = query(collection(db,"products"), orderBy("createdAt","desc"));
    unsub = onSnapshot(qy,(snap)=>{
      if(snap.empty){
        list.innerHTML = `<tr><td colspan="6">No products yet.</td></tr>`;
        return;
      }
      list.innerHTML = snap.docs.map(d=>{
        const p = d.data();
        const id = d.id;

        const disc = p.discountEnabled ? `<span class="pill on">ON</span>` : `<span class="pill off">OFF</span>`;
        const stock = p.outOfStock ? `<span class="pill off">OUT</span>` : `<span class="pill on">IN</span>`;

        return `
          <tr data-id="${id}">
            <td>${p.imageUrl ? `<img src="${p.imageUrl}" style="width:55px;height:55px;object-fit:cover;border-radius:8px;">` : ""}</td>
            <td>${p.name||""}</td>
            <td>GHC ${p.price||""}</td>
            <td>${disc}</td>
            <td>${stock}</td>
            <td class="actions">
              <button type="button" class="btnSmall" data-action="set-discount">Set Discount</button>
              <button type="button" class="btnSmall" data-action="set-stock">Set Stock</button>
              <button type="button" class="btnSmall danger" data-action="delete">Delete</button>
            </td>
          </tr>
        `;
      }).join("");
    });
  }

  // Actions
  list.addEventListener("click", async (e)=>{
    const btn = e.target.closest("button[data-action]");
    if(!btn) return;

    const row = btn.closest("tr[data-id]");
    const id = row.dataset.id;
    const refDoc = doc(db,"products",id);

    try{
      if(btn.dataset.action==="set-discount"){
        const setTo = confirm("Set DISCOUNT to ON?\nOK = ON, Cancel = OFF");
        await updateDoc(refDoc,{ discountEnabled: setTo });
        return;
      }
      if(btn.dataset.action==="set-stock"){
        const setTo = confirm("Mark as OUT OF STOCK?\nOK = OUT, Cancel = IN STOCK");
        await updateDoc(refDoc,{ outOfStock: setTo });
        return;
      }
      if(btn.dataset.action==="delete"){
        if(!confirm("Delete this product?")) return;
        await deleteDoc(refDoc);
        alert("✅ Deleted");
      }
    }catch(err){
      console.error(err);
      alert("❌ Action failed: " + (err.message || "Try again"));
    }
  });
</script>

</body>
</html>
