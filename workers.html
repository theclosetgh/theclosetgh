<script type="module">
  const API_BASE = "https://the-closet-api.edriatebi2.workers.dev";

  // Cloudinary
  const CLOUD_NAME = "dwpwtanc8";
  const UPLOAD_PRESET = "the_closet";

  const TOKEN_KEY = "thecloset_admin_token";

  // UI
  const loginCard = document.getElementById("loginCard");
  const loginForm = document.getElementById("loginForm");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const workersUI = document.getElementById("workersUI");

  const productForm = document.getElementById("productForm");
  const submitBtn = document.getElementById("submitBtn");
  const list = document.getElementById("list");

  function getToken() {
    return localStorage.getItem(TOKEN_KEY) || "";
  }
  function setToken(t) {
    if (!t) localStorage.removeItem(TOKEN_KEY);
    else localStorage.setItem(TOKEN_KEY, t);
  }

  function api(path, opts = {}) {
    const headers = Object.assign(
      { "Content-Type": "application/json" },
      opts.headers || {}
    );

    const t = getToken();
    if (t) headers["Authorization"] = "Bearer " + t;

    return fetch(API_BASE + path, Object.assign({}, opts, { headers }));
  }

  function showAuthed(isAuthed) {
    if (!isAuthed) {
      workersUI.classList.add("hide");
      logoutBtn.classList.add("hide");
      loginCard.classList.remove("hide");
      list.innerHTML = "";
      return;
    }
    loginCard.classList.add("hide");
    workersUI.classList.remove("hide");
    logoutBtn.classList.remove("hide");
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // Cloudinary upload
  async function uploadToCloudinary(file){
    const url = "https://api.cloudinary.com/v1_1/" + CLOUD_NAME + "/image/upload";
    const fd = new FormData();
    fd.append("file", file);
    fd.append("upload_preset", UPLOAD_PRESET);
    fd.append("folder", "the-closet");

    const res = await fetch(url, { method:"POST", body: fd });
    const data = await res.json();
    if (!res.ok) throw new Error((data && data.error && data.error.message) ? data.error.message : "Cloudinary upload failed");
    return data.secure_url;
  }

  async function loadProducts(){
    const res = await fetch(API_BASE + "/api/products");
    const data = await res.json().catch(()=>({ ok:false }));
    if (!res.ok || !data.ok) {
      list.innerHTML = "<tr><td colspan='6'>❌ Failed to load products</td></tr>";
      return;
    }

    const products = data.products || [];
    if (!products.length) {
      list.innerHTML = "<tr><td colspan='6'>No products yet.</td></tr>";
      return;
    }

    list.innerHTML = products.map(p=>{
      const disc = p.discountEnabled ? "<span class='pill on'>ON</span>" : "<span class='pill off'>OFF</span>";
      const stock = p.outOfStock ? "<span class='pill off'>OUT</span>" : "<span class='pill on'>IN</span>";

      return (
        "<tr data-id='" + escapeHtml(p.id) + "'>" +
          "<td>" + (p.imageUrl ? "<img src='" + escapeHtml(p.imageUrl) + "' style='width:55px;height:55px;object-fit:cover;border-radius:8px;'>" : "") + "</td>" +
          "<td>" + escapeHtml(p.name || "") + "</td>" +
          "<td>GHC " + escapeHtml(String(p.price || "")) + "</td>" +
          "<td>" + disc + " <span class='tiny'>(" + escapeHtml(String(p.discountPercent || 0)) + "%)</span></td>" +
          "<td>" + stock + "</td>" +
          "<td class='actions'>" +
            "<button type='button' class='btnSmall' data-action='set-discount'>Set Discount</button>" +
            "<button type='button' class='btnSmall' data-action='set-stock'>Set Stock</button>" +
            "<button type='button' class='btnSmall danger' data-action='delete'>Delete</button>" +
          "</td>" +
        "</tr>"
      );
    }).join("");
  }

  // Login (password only)
  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    loginBtn.disabled = true;
    loginBtn.textContent = "Signing in...";

    try {
      const pass = document.getElementById("loginPass").value;

      const res = await api("/api/login", {
        method: "POST",
        body: JSON.stringify({ password: pass })
      });
      const data = await res.json().catch(()=>({}));

      if (!res.ok || !data.ok || !data.token) {
        throw new Error(data.error || "Login failed");
      }

      setToken(data.token);
      showAuthed(true);
      await loadProducts();
    } catch (err) {
      alert("❌ Login failed: " + (err && err.message ? err.message : "Try again"));
      setToken("");
      showAuthed(false);
    } finally {
      loginBtn.disabled = false;
      loginBtn.textContent = "Sign in";
    }
  });

  // Logout
  logoutBtn.addEventListener("click", async () => {
    setToken("");
    showAuthed(false);
    location.replace("/#home");
  });

  // Add product
  productForm.addEventListener("submit", async (e)=>{
    e.preventDefault();

    const name = document.getElementById("name").value.trim();
    const price = Number(document.getElementById("price").value);
    const sizes = document.getElementById("sizes").value.split(",").map(s=>s.trim()).filter(Boolean);
    const discountEnabled = document.getElementById("discountEnabled").checked;
    const outOfStock = document.getElementById("outOfStock").checked;

    // Ask discount percent if enabled
    let discountPercent = 0;
    if (discountEnabled) {
      const p = prompt("Discount percent? (0 - 90)", "10");
      discountPercent = Math.max(0, Math.min(90, Math.round(Number(p || 0))));
    }

    const file = document.getElementById("imageFile").files[0];
    if (!file) { alert("Upload an image."); return; }

    submitBtn.disabled = true;
    submitBtn.textContent = "Uploading image...";

    try {
      const imageUrl = await uploadToCloudinary(file);
      submitBtn.textContent = "Saving product...";

      const res = await api("/api/products", {
        method: "POST",
        body: JSON.stringify({
          name: name,
          price: price,
          sizes: sizes,
          imageUrl: imageUrl,
          discountEnabled: discountEnabled,
          discountPercent: discountPercent,
          outOfStock: outOfStock
        })
      });

      const data = await res.json().catch(()=>({}));
      if (!res.ok || !data.ok) throw new Error(data.error || "Failed to save");

      alert("✅ Product added!");
      productForm.reset();
      await loadProducts();
    } catch (err) {
      alert("❌ Failed: " + (err && err.message ? err.message : "Try again"));
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Upload & Add Product";
    }
  });

  // Row actions
  list.addEventListener("click", async (e)=>{
    const btn = e.target.closest("button[data-action]");
    if (!btn) return;

    const row = btn.closest("tr[data-id]");
    const id = row ? row.getAttribute("data-id") : "";
    if (!id) return;

    try {
      if (btn.dataset.action === "set-discount") {
        const enable = confirm("Set DISCOUNT to ON?\nOK = ON, Cancel = OFF");
        let pct = 0;
        if (enable) {
          const p = prompt("Discount percent? (0 - 90)", "10");
          pct = Math.max(0, Math.min(90, Math.round(Number(p || 0))));
        }

        const res = await api("/api/products/" + encodeURIComponent(id), {
          method: "PUT",
          body: JSON.stringify({ discountEnabled: enable, discountPercent: pct })
        });
        const data = await res.json().catch(()=>({}));
        if (!res.ok || !data.ok) throw new Error(data.error || "Action failed");
        await loadProducts();
        return;
      }

      if (btn.dataset.action === "set-stock") {
        const setOut = confirm("Mark as OUT OF STOCK?\nOK = OUT, Cancel = IN STOCK");

        const res = await api("/api/products/" + encodeURIComponent(id), {
          method: "PUT",
          body: JSON.stringify({ outOfStock: setOut })
        });
        const data = await res.json().catch(()=>({}));
        if (!res.ok || !data.ok) throw new Error(data.error || "Action failed");
        await loadProducts();
        return;
      }

      if (btn.dataset.action === "delete") {
        if (!confirm("Delete this product?")) return;

        const res = await api("/api/products/" + encodeURIComponent(id), { method: "DELETE" });
        const data = await res.json().catch(()=>({}));
        if (!res.ok || !data.ok) throw new Error(data.error || "Delete failed");

        alert("✅ Deleted");
        await loadProducts();
      }
    } catch (err) {
      alert("❌ Action failed: " + (err && err.message ? err.message : "Try again"));
    }
  });

  // Auto-show login or load if token exists
  (async function init(){
    if (getToken()) {
      showAuthed(true);
      await loadProducts();
    } else {
      showAuthed(false);
    }
  })();
</script>
